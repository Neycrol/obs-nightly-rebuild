name: OBS Convergence Watch

on:
  workflow_dispatch:
  workflow_run:
    workflows:
      - OBS Nightly Rebuild
    types:
      - completed
  schedule:
    # Periodic convergence check/recovery (UTC): hourly at :15
    - cron: '15 * * * *'

concurrency:
  group: obs-convergence-watch
  cancel-in-progress: false

jobs:
  converge:
    runs-on: ubuntu-latest
    timeout-minutes: 40
    steps:
      - name: Install osc client
        run: |
          sudo apt-get update
          sudo apt-get install -y osc

      - name: Configure osc credentials
        env:
          OBS_APIURL: ${{ secrets.OBS_APIURL }}
          OBS_USERNAME: ${{ secrets.OBS_USERNAME }}
          OBS_PASSWORD: ${{ secrets.OBS_PASSWORD }}
        run: |
          : "${OBS_APIURL:=https://api.opensuse.org}"
          printf '[general]\napiurl = %s\n\n[%s]\nuser = %s\npass = %s\ncredentials_mgr_class = osc.credentials.PlaintextConfigFileCredentialsManager\n' \
            "$OBS_APIURL" "$OBS_APIURL" "$OBS_USERNAME" "$OBS_PASSWORD" > "$HOME/.oscrc"
          chmod 600 "$HOME/.oscrc"

      - name: Check convergence and auto-retry hard failures
        env:
          OBS_MAIN_PROJECT: ${{ secrets.OBS_PROJECT }}
          OBS_MAIN_REPO: ${{ secrets.OBS_REPO }}
          OBS_ARCH: ${{ secrets.OBS_ARCH }}
        run: |
          set -euo pipefail

          retry_cmd() {
            local max_attempts="${RETRY_MAX_ATTEMPTS:-5}"
            local delay="${RETRY_INITIAL_DELAY:-3}"
            local attempt=1
            while true; do
              "$@" && return 0
              local rc=$?
              if [ "$attempt" -ge "$max_attempts" ]; then
                echo "ERROR: command failed after ${attempt} attempts (rc=${rc}): $*" >&2
                return "$rc"
              fi
              echo "WARN: command failed (rc=${rc}), retry ${attempt}/${max_attempts} in ${delay}s: $*" >&2
              sleep "$delay"
              attempt=$((attempt + 1))
              delay=$((delay * 2))
              if [ "$delay" -gt 30 ]; then
                delay=30
              fi
            done
          }

          : "${OBS_MAIN_PROJECT:=home:neycrol:buildfactory}"
          : "${OBS_MAIN_REPO:=buildfactory}"
          : "${OBS_ARCH:=x86_64}"

          results_csv="$(mktemp)"
          retry_cmd osc results "$OBS_MAIN_PROJECT" -r "$OBS_MAIN_REPO" -a "$OBS_ARCH" --csv > "$results_csv"

          read -r succeeded blocked building scheduled dispatching signing finished failed broken unresolvable excluded disabled < <(
            awk -F';' '
              NF>=2 && $1!="_" { c[$2]++ }
              END {
                print c["succeeded"]+0, c["blocked"]+0, c["building"]+0,
                      c["scheduled"]+0, c["dispatching"]+0, c["signing"]+0,
                      c["finished"]+0, c["failed"]+0, c["broken"]+0,
                      c["unresolvable"]+0, c["excluded"]+0, c["disabled"]+0
              }' "$results_csv"
          )

          echo "main states: succeeded=${succeeded} blocked=${blocked} building=${building} scheduled=${scheduled} dispatching=${dispatching} signing=${signing} finished=${finished} failed=${failed} broken=${broken} unresolvable=${unresolvable} excluded=${excluded} disabled=${disabled}"
          {
            echo "## OBS convergence snapshot"
            echo ""
            echo "- project: \`$OBS_MAIN_PROJECT\`"
            echo "- repo/arch: \`$OBS_MAIN_REPO/$OBS_ARCH\`"
            echo "- states: succeeded=$succeeded blocked=$blocked building=$building scheduled=$scheduled dispatching=$dispatching signing=$signing finished=$finished failed=$failed broken=$broken unresolvable=$unresolvable excluded=$excluded disabled=$disabled"
          } >> "$GITHUB_STEP_SUMMARY"

          hard_fail=$((failed + broken + unresolvable))
          if [ "$hard_fail" -gt 0 ]; then
            echo "hard failure states detected; listing and scheduling targeted retries"
            awk -F';' '$2=="failed" || $2=="broken" || $2=="unresolvable"{print}' "$results_csv"

            mapfile -t bad_pkgs < <(
              awk -F';' '$2=="failed" || $2=="broken" || $2=="unresolvable"{print $1}' "$results_csv" | sort -u
            )

            retried_any=0
            skipped_toolchain=0
            retried_pkgs=()
            skipped_pkgs=()
            for pkg in "${bad_pkgs[@]}"; do
              [ -n "$pkg" ] || continue
              echo "----- buildlog tail: ${pkg} -----"
              log_tail="$(mktemp)"
              retry_cmd osc remotebuildlog "$OBS_MAIN_PROJECT" "$pkg" "$OBS_MAIN_REPO" "$OBS_ARCH" 2>/dev/null | tail -n 120 > "$log_tail" || true
              cat "$log_tail"

              if grep -Eq 'cannot find crtbeginS\.o|cannot find -lgcc|linker .*linux-gnu-gcc.* not found' "$log_tail"; then
                echo "skip rebuildpac: ${pkg} (toolchain compatibility blocker detected: missing crtbeginS.o/-lgcc)"
                skipped_toolchain=$((skipped_toolchain + 1))
                skipped_pkgs+=("$pkg")
                continue
              fi

              echo "rebuildpac: ${pkg}"
              retry_cmd osc rebuildpac "$OBS_MAIN_PROJECT" "$pkg" "$OBS_MAIN_REPO" "$OBS_ARCH" || true
              retried_any=$((retried_any + 1))
              retried_pkgs+=("$pkg")
            done

            {
              echo ""
              echo "### Retried packages"
              if [ "$retried_any" -eq 0 ]; then
                echo "- (none)"
              else
                for pkg in "${retried_pkgs[@]}"; do
                  echo "- \`$pkg\`"
                done
              fi
              if [ "$skipped_toolchain" -gt 0 ]; then
                echo ""
                echo "### Toolchain blockers"
                echo "- Detected GCC toolchain compatibility failures (\`crtbeginS.o\`/ \`-lgcc\` missing or GNU gcc linker not found)."
                echo "- Auto-retry is intentionally skipped for those packages to avoid reset loops."
                echo "- Action required: fix GCC packaging compatibility (startup objects/linker search path)."
                for pkg in "${skipped_pkgs[@]}"; do
                  echo "- \`$pkg\`"
                done
              fi
            } >> "$GITHUB_STEP_SUMMARY"

            if [ "$skipped_toolchain" -gt 0 ]; then
              echo "hard failure states include toolchain blockers; manual action required" >&2
              exit 1
            fi

            if [ "$retried_any" -gt 0 ]; then
              echo "targeted retries scheduled; let next convergence cycle validate final state"
              exit 0
            fi

            echo "hard failure states detected but no retry action was applied" >&2
            exit 1
          fi

          active=$((blocked + building + scheduled + dispatching + signing))
          if [ "$active" -gt 0 ]; then
            echo "project is still converging on OBS; no hard failure states"
            exit 0
          fi

          echo "project converged: no active states and no hard failures"

      - name: Print single-repo URL
        run: |
          echo "https://downloadcontent.opensuse.org/repositories/home:/neycrol:/buildfactory/buildfactory/x86_64/"
          echo "db file: home_neycrol_buildfactory_buildfactory.db"
