name: OBS Nightly Full Rebuild

on:
  schedule:
    # Europe evening (UTC winter): 19:40
    - cron: '40 19 * * *'
    # US evening (UTC winter): 03:40
    - cron: '40 3 * * *'
  workflow_dispatch: {}

jobs:
  rebuild:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Install osc client
        run: |
          sudo apt-get update
          sudo apt-get install -y osc

      - name: Configure osc credentials
        env:
          OBS_APIURL: ${{ secrets.OBS_APIURL }}
          OBS_USERNAME: ${{ secrets.OBS_USERNAME }}
          OBS_PASSWORD: ${{ secrets.OBS_PASSWORD }}
        run: |
          : "${OBS_APIURL:=https://api.opensuse.org}"
          mkdir -p "$HOME"
          cat > "$HOME/.oscrc" <<EOC
[general]
apiurl = ${OBS_APIURL}

[${OBS_APIURL}]
user = ${OBS_USERNAME}
pass = ${OBS_PASSWORD}
credentials_mgr_class = PlaintextConfigFileCredentialsManager
EOC
          chmod 600 "$HOME/.oscrc"

      - name: Trigger full project rebuild on OBS
        env:
          OBS_PROJECT: ${{ secrets.OBS_PROJECT }}
          OBS_REPO: ${{ secrets.OBS_REPO }}
          OBS_ARCH: ${{ secrets.OBS_ARCH }}
        run: |
          : "${OBS_PROJECT:=home:neycrol:buildfactory}"
          : "${OBS_REPO:=buildfactory}"
          : "${OBS_ARCH:=x86_64}"
          osc rebuild --all --repo "$OBS_REPO" --arch "$OBS_ARCH" "$OBS_PROJECT"

      - name: Print current status summary
        env:
          OBS_PROJECT: ${{ secrets.OBS_PROJECT }}
        run: |
          : "${OBS_PROJECT:=home:neycrol:buildfactory}"
          osc results "$OBS_PROJECT" || true
