name: OBS Nightly Rebuild

on:
  workflow_dispatch:
  schedule:
    # Europe evening (UTC winter): 19:40
    - cron: '40 19 * * *'
    # US evening (UTC winter): 03:40
    - cron: '40 3 * * *'

concurrency:
  group: obs-nightly-rebuild
  cancel-in-progress: false

jobs:
  rebuild:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Install osc client
        run: |
          sudo apt-get update
          sudo apt-get install -y osc

      - name: Configure osc credentials
        env:
          OBS_APIURL: ${{ secrets.OBS_APIURL }}
          OBS_USERNAME: ${{ secrets.OBS_USERNAME }}
          OBS_PASSWORD: ${{ secrets.OBS_PASSWORD }}
        run: |
          : "${OBS_APIURL:=https://api.opensuse.org}"
          printf '[general]\napiurl = %s\n\n[%s]\nuser = %s\npass = %s\ncredentials_mgr_class = osc.credentials.PlaintextConfigFileCredentialsManager\n' \
            "$OBS_APIURL" "$OBS_APIURL" "$OBS_USERNAME" "$OBS_PASSWORD" > "$HOME/.oscrc"
          chmod 600 "$HOME/.oscrc"

      - name: Refresh source services once per nightly batch
        env:
          OBS_PROJECT: ${{ secrets.OBS_PROJECT }}
          OBS_REPO: ${{ secrets.OBS_REPO }}
          OBS_ARCH: ${{ secrets.OBS_ARCH }}
        run: |
          : "${OBS_PROJECT:=home:neycrol:buildfactory}"
          : "${OBS_REPO:=buildfactory}"
          : "${OBS_ARCH:=x86_64}"
          PACKAGES=(
            android-android-tools-git
            android-scrcpy-git
            aur_published-bcachefs-kernel-dkms-git
            aur_published-bcachefs-tools-git
            aur_published-prismlauncher-zlib-compat-git
            cmake-git
            gcc-git-god
            glibc-god
            kde-bolt-konsole-git
            kde-bolt-kscreen
            kde-bolt-kwin
            kde-bolt-libkscreen
            kde-bolt-libplasma
            kde-bolt-plasma-workspace
            kde-bolt-protocols
            llvm-bolt-ndk
            media-ffmpeg-god-git
            network-clash2singbox-git
            network-sing-box-master-git
            network-subconverter-optimized-git
            pacman-contrib-god
            pacman-git
            pacman-git-icu-god
            pacutils-god
            paru
            tools-cursor-agent-bin
            tools-fish_pgo
          )

          fail_count=0
          for pkg in "${PACKAGES[@]}"; do
            status_xml="$(osc api "/build/${OBS_PROJECT}/${OBS_REPO}/${OBS_ARCH}/${pkg}/_status" 2>/dev/null || true)"
            if echo "$status_xml" | grep -q 'code="building"'; then
              echo "skip runservice: $pkg (currently building)"
              continue
            fi
            if echo "$status_xml" | grep -q 'service in progress'; then
              echo "skip runservice: $pkg (service already in progress)"
              continue
            fi

            echo "runservice: $pkg"
            if ! osc api -X POST "/source/${OBS_PROJECT}/${pkg}?cmd=runservice" >/dev/null; then
              echo "WARN: runservice failed for $pkg" >&2
              fail_count=$((fail_count + 1))
            fi
          done

          echo "runservice failed packages: $fail_count"
          # Keep rebuild flow running even if a few runservice calls fail.
          # The next nightly run will retry.

      - name: Trigger full project rebuild on OBS
        env:
          OBS_PROJECT: ${{ secrets.OBS_PROJECT }}
          OBS_REPO: ${{ secrets.OBS_REPO }}
          OBS_ARCH: ${{ secrets.OBS_ARCH }}
        run: |
          : "${OBS_PROJECT:=home:neycrol:buildfactory}"
          : "${OBS_REPO:=buildfactory}"
          : "${OBS_ARCH:=x86_64}"
          osc rebuild --all --repo "$OBS_REPO" --arch "$OBS_ARCH" "$OBS_PROJECT"

      - name: Print current status summary
        env:
          OBS_PROJECT: ${{ secrets.OBS_PROJECT }}
        run: |
          : "${OBS_PROJECT:=home:neycrol:buildfactory}"
          osc results "$OBS_PROJECT" || true
