name: OBS Nightly Rebuild

on:
  workflow_dispatch:
  schedule:
    # Daily run (UTC): 19:40
    - cron: '40 19 * * *'

concurrency:
  group: obs-nightly-rebuild
  cancel-in-progress: false

jobs:
  rebuild:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:
      - name: Install osc client
        run: |
          sudo apt-get update
          sudo apt-get install -y osc

      - name: Configure osc credentials
        env:
          OBS_APIURL: ${{ secrets.OBS_APIURL }}
          OBS_USERNAME: ${{ secrets.OBS_USERNAME }}
          OBS_PASSWORD: ${{ secrets.OBS_PASSWORD }}
        run: |
          : "${OBS_APIURL:=https://api.opensuse.org}"
          printf '[general]\napiurl = %s\n\n[%s]\nuser = %s\npass = %s\ncredentials_mgr_class = osc.credentials.PlaintextConfigFileCredentialsManager\n' \
            "$OBS_APIURL" "$OBS_APIURL" "$OBS_USERNAME" "$OBS_PASSWORD" > "$HOME/.oscrc"
          chmod 600 "$HOME/.oscrc"

      - name: Refresh source services (bootstrap only)
        env:
          OBS_BOOTSTRAP_PROJECT: ${{ secrets.OBS_BOOTSTRAP_PROJECT }}
          OBS_BOOTSTRAP_REPO: ${{ secrets.OBS_BOOTSTRAP_REPO }}
          OBS_ARCH: ${{ secrets.OBS_ARCH }}
        run: |
          : "${OBS_BOOTSTRAP_PROJECT:=home:neycrol:buildfactory-bootstrap}"
          : "${OBS_BOOTSTRAP_REPO:=bootstrap}"
          : "${OBS_ARCH:=x86_64}"

          refresh_services_for_project() {
            local project="$1"
            local repo="$2"
            local failed=0
            local total=0
            local svc=0

            while IFS= read -r pkg; do
              [ -n "$pkg" ] || continue
              total=$((total + 1))

              if ! osc cat "$project" "$pkg" _service >/dev/null 2>&1; then
                continue
              fi
              svc=$((svc + 1))

              status_xml="$(osc api "/build/${project}/${repo}/${OBS_ARCH}/${pkg}/_status" 2>/dev/null || true)"
              if echo "$status_xml" | grep -q 'code="building"'; then
                echo "skip runservice: ${project}/${pkg} (currently building)"
                continue
              fi
              if echo "$status_xml" | grep -q 'service in progress'; then
                echo "skip runservice: ${project}/${pkg} (service in progress)"
                continue
              fi

              echo "runservice: ${project}/${pkg}"
              if ! osc api -X POST "/source/${project}/${pkg}?cmd=runservice" >/dev/null; then
                echo "WARN: runservice failed for ${project}/${pkg}" >&2
                failed=$((failed + 1))
              fi
            done < <(osc ls "$project")

            echo "project=${project} packages=${total} service_packages=${svc} runservice_failed=${failed}"
          }

          refresh_services_for_project "$OBS_BOOTSTRAP_PROJECT" "$OBS_BOOTSTRAP_REPO"

      - name: Rebuild bootstrap project first (glibc producer)
        env:
          OBS_BOOTSTRAP_PROJECT: ${{ secrets.OBS_BOOTSTRAP_PROJECT }}
          OBS_BOOTSTRAP_REPO: ${{ secrets.OBS_BOOTSTRAP_REPO }}
          OBS_ARCH: ${{ secrets.OBS_ARCH }}
        run: |
          : "${OBS_BOOTSTRAP_PROJECT:=home:neycrol:buildfactory-bootstrap}"
          : "${OBS_BOOTSTRAP_REPO:=bootstrap}"
          : "${OBS_ARCH:=x86_64}"
          osc rebuild --all --repo "$OBS_BOOTSTRAP_REPO" --arch "$OBS_ARCH" "$OBS_BOOTSTRAP_PROJECT"

      - name: Wait bootstrap glibc producer to finish
        env:
          OBS_BOOTSTRAP_PROJECT: ${{ secrets.OBS_BOOTSTRAP_PROJECT }}
          OBS_BOOTSTRAP_REPO: ${{ secrets.OBS_BOOTSTRAP_REPO }}
          OBS_ARCH: ${{ secrets.OBS_ARCH }}
        run: |
          : "${OBS_BOOTSTRAP_PROJECT:=home:neycrol:buildfactory-bootstrap}"
          : "${OBS_BOOTSTRAP_REPO:=bootstrap}"
          : "${OBS_ARCH:=x86_64}"

          timeout_sec=$((5 * 60 * 60))
          interval=30
          elapsed=0

          while true; do
            state="$(osc results "$OBS_BOOTSTRAP_PROJECT" -r "$OBS_BOOTSTRAP_REPO" -a "$OBS_ARCH" --csv \
              | awk -F';' '$1=="glibc-god"{print $2}')"

            echo "bootstrap glibc-god state=${state:-unknown} elapsed=${elapsed}s"
            case "$state" in
              succeeded|published|finished)
                break
                ;;
              failed|broken|unresolvable|excluded|disabled)
                echo "bootstrap glibc-god ended in non-success state: $state" >&2
                exit 1
                ;;
            esac

            if [ "$elapsed" -ge "$timeout_sec" ]; then
              echo "timeout waiting for bootstrap glibc-god to finish" >&2
              exit 1
            fi

            sleep "$interval"
            elapsed=$((elapsed + interval))
          done

      - name: Refresh source services (main only)
        env:
          OBS_MAIN_PROJECT: ${{ secrets.OBS_PROJECT }}
          OBS_MAIN_REPO: ${{ secrets.OBS_REPO }}
          OBS_ARCH: ${{ secrets.OBS_ARCH }}
        run: |
          : "${OBS_MAIN_PROJECT:=home:neycrol:buildfactory}"
          : "${OBS_MAIN_REPO:=buildfactory}"
          : "${OBS_ARCH:=x86_64}"

          failed=0
          total=0
          svc=0

          while IFS= read -r pkg; do
            [ -n "$pkg" ] || continue
            total=$((total + 1))

            if ! osc cat "$OBS_MAIN_PROJECT" "$pkg" _service >/dev/null 2>&1; then
              continue
            fi
            svc=$((svc + 1))

            status_xml="$(osc api "/build/${OBS_MAIN_PROJECT}/${OBS_MAIN_REPO}/${OBS_ARCH}/${pkg}/_status" 2>/dev/null || true)"
            if echo "$status_xml" | grep -q 'code="building"'; then
              echo "skip runservice: ${OBS_MAIN_PROJECT}/${pkg} (currently building)"
              continue
            fi
            if echo "$status_xml" | grep -q 'service in progress'; then
              echo "skip runservice: ${OBS_MAIN_PROJECT}/${pkg} (service in progress)"
              continue
            fi

            echo "runservice: ${OBS_MAIN_PROJECT}/${pkg}"
            if ! osc api -X POST "/source/${OBS_MAIN_PROJECT}/${pkg}?cmd=runservice" >/dev/null; then
              echo "WARN: runservice failed for ${OBS_MAIN_PROJECT}/${pkg}" >&2
              failed=$((failed + 1))
            fi
          done < <(osc ls "$OBS_MAIN_PROJECT")

          echo "project=${OBS_MAIN_PROJECT} packages=${total} service_packages=${svc} runservice_failed=${failed}"

      - name: Trigger main project full rebuild on OBS
        env:
          OBS_MAIN_PROJECT: ${{ secrets.OBS_PROJECT }}
          OBS_MAIN_REPO: ${{ secrets.OBS_REPO }}
          OBS_ARCH: ${{ secrets.OBS_ARCH }}
        run: |
          : "${OBS_MAIN_PROJECT:=home:neycrol:buildfactory}"
          : "${OBS_MAIN_REPO:=buildfactory}"
          : "${OBS_ARCH:=x86_64}"
          # Main project holds the single consumer repo and includes glibc-god aggregate package.
          osc rebuild --all --repo "$OBS_MAIN_REPO" --arch "$OBS_ARCH" "$OBS_MAIN_PROJECT"
          # Ensure glibc aggregate is scheduled right after bootstrap producer completion.
          osc rebuildpac "$OBS_MAIN_PROJECT" glibc-god "$OBS_MAIN_REPO" "$OBS_ARCH" || true

      - name: Wait main project to settle and fail on broken states
        env:
          OBS_MAIN_PROJECT: ${{ secrets.OBS_PROJECT }}
          OBS_MAIN_REPO: ${{ secrets.OBS_REPO }}
          OBS_ARCH: ${{ secrets.OBS_ARCH }}
        run: |
          : "${OBS_MAIN_PROJECT:=home:neycrol:buildfactory}"
          : "${OBS_MAIN_REPO:=buildfactory}"
          : "${OBS_ARCH:=x86_64}"

          timeout_sec=$((5 * 60 * 60))
          interval=60
          elapsed=0

          while true; do
            read -r succeeded blocked building scheduled dispatching signing finished failed broken unresolvable excluded disabled < <(
              osc results "$OBS_MAIN_PROJECT" -r "$OBS_MAIN_REPO" -a "$OBS_ARCH" --csv \
              | awk -F';' '
                  NF>=2 && $1!="_" { c[$2]++ }
                  END {
                    print c["succeeded"]+0, c["blocked"]+0, c["building"]+0,
                          c["scheduled"]+0, c["dispatching"]+0, c["signing"]+0,
                          c["finished"]+0, c["failed"]+0, c["broken"]+0,
                          c["unresolvable"]+0, c["excluded"]+0, c["disabled"]+0
                  }'
            )

            echo "main states: succeeded=${succeeded} blocked=${blocked} building=${building} scheduled=${scheduled} dispatching=${dispatching} signing=${signing} finished=${finished} failed=${failed} broken=${broken} unresolvable=${unresolvable} excluded=${excluded} disabled=${disabled} elapsed=${elapsed}s"

            if [ "$failed" -gt 0 ] || [ "$broken" -gt 0 ] || [ "$unresolvable" -gt 0 ]; then
              echo "main project entered failure states" >&2
              osc results "$OBS_MAIN_PROJECT" -r "$OBS_MAIN_REPO" -a "$OBS_ARCH" --csv \
                | awk -F';' '$2=="failed" || $2=="broken" || $2=="unresolvable"{print}'
              exit 1
            fi

            active=$((blocked + building + scheduled + dispatching + signing))
            if [ "$active" -eq 0 ]; then
              break
            fi

            if [ "$elapsed" -ge "$timeout_sec" ]; then
              echo "timeout waiting for main project to settle" >&2
              exit 1
            fi

            sleep "$interval"
            elapsed=$((elapsed + interval))
          done

      - name: Print current status summary
        env:
          OBS_BOOTSTRAP_PROJECT: ${{ secrets.OBS_BOOTSTRAP_PROJECT }}
          OBS_BOOTSTRAP_REPO: ${{ secrets.OBS_BOOTSTRAP_REPO }}
          OBS_MAIN_PROJECT: ${{ secrets.OBS_PROJECT }}
          OBS_MAIN_REPO: ${{ secrets.OBS_REPO }}
          OBS_ARCH: ${{ secrets.OBS_ARCH }}
        run: |
          : "${OBS_BOOTSTRAP_PROJECT:=home:neycrol:buildfactory-bootstrap}"
          : "${OBS_BOOTSTRAP_REPO:=bootstrap}"
          : "${OBS_MAIN_PROJECT:=home:neycrol:buildfactory}"
          : "${OBS_MAIN_REPO:=buildfactory}"
          : "${OBS_ARCH:=x86_64}"

          echo "=== bootstrap summary ==="
          osc results "$OBS_BOOTSTRAP_PROJECT" -r "$OBS_BOOTSTRAP_REPO" -a "$OBS_ARCH" || true
          echo "=== main summary ==="
          osc results "$OBS_MAIN_PROJECT" -r "$OBS_MAIN_REPO" -a "$OBS_ARCH" || true

          echo "=== single pacman repo (published path) ==="
          echo "https://downloadcontent.opensuse.org/repositories/home:/neycrol:/buildfactory/buildfactory/x86_64/"
          echo "db file: home_neycrol_buildfactory_buildfactory.db"
