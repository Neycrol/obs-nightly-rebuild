name: OBS Nightly Rebuild

on:
  workflow_dispatch:
  schedule:
    # Daily run (UTC): 19:40
    - cron: '40 19 * * *'

concurrency:
  group: obs-nightly-rebuild
  cancel-in-progress: false

jobs:
  rebuild:
    runs-on: ubuntu-latest
    timeout-minutes: 480
    steps:
      - name: Install osc client
        run: |
          sudo apt-get update
          sudo apt-get install -y osc

      - name: Configure osc credentials
        env:
          OBS_APIURL: ${{ secrets.OBS_APIURL }}
          OBS_USERNAME: ${{ secrets.OBS_USERNAME }}
          OBS_PASSWORD: ${{ secrets.OBS_PASSWORD }}
        run: |
          : "${OBS_APIURL:=https://api.opensuse.org}"
          printf '[general]\napiurl = %s\n\n[%s]\nuser = %s\npass = %s\ncredentials_mgr_class = osc.credentials.PlaintextConfigFileCredentialsManager\n' \
            "$OBS_APIURL" "$OBS_APIURL" "$OBS_USERNAME" "$OBS_PASSWORD" > "$HOME/.oscrc"
          chmod 600 "$HOME/.oscrc"

      - name: Refresh source services (bootstrap only)
        env:
          OBS_BOOTSTRAP_PROJECT: ${{ secrets.OBS_BOOTSTRAP_PROJECT }}
          OBS_BOOTSTRAP_REPO: ${{ secrets.OBS_BOOTSTRAP_REPO }}
          OBS_ARCH: ${{ secrets.OBS_ARCH }}
        run: |
          set -euo pipefail

          : "${OBS_BOOTSTRAP_PROJECT:=home:neycrol:buildfactory-bootstrap}"
          : "${OBS_BOOTSTRAP_REPO:=bootstrap}"
          : "${OBS_ARCH:=x86_64}"

          retry_cmd() {
            local max_attempts="${RETRY_MAX_ATTEMPTS:-5}"
            local delay="${RETRY_INITIAL_DELAY:-3}"
            local attempt=1
            while true; do
              "$@" && return 0
              local rc=$?
              if [ "$attempt" -ge "$max_attempts" ]; then
                echo "ERROR: command failed after ${attempt} attempts (rc=${rc}): $*" >&2
                return "$rc"
              fi
              echo "WARN: command failed (rc=${rc}), retry ${attempt}/${max_attempts} in ${delay}s: $*" >&2
              sleep "$delay"
              attempt=$((attempt + 1))
              delay=$((delay * 2))
              if [ "$delay" -gt 30 ]; then
                delay=30
              fi
            done
          }

          refresh_services_for_project() {
            local project="$1"
            local repo="$2"
            local failed=0
            local total=0
            local svc=0

            mapfile -t pkgs < <(retry_cmd osc ls "$project")
            for pkg in "${pkgs[@]}"; do
              [ -n "$pkg" ] || continue
              total=$((total + 1))

              if ! osc cat "$project" "$pkg" _service >/dev/null 2>&1; then
                continue
              fi
              svc=$((svc + 1))

              status_xml="$(osc api "/build/${project}/${repo}/${OBS_ARCH}/${pkg}/_status" 2>/dev/null || true)"
              if echo "$status_xml" | grep -q 'code="building"'; then
                echo "skip runservice: ${project}/${pkg} (currently building)"
                continue
              fi
              if echo "$status_xml" | grep -q 'service in progress'; then
                echo "skip runservice: ${project}/${pkg} (service in progress)"
                continue
              fi

              echo "runservice: ${project}/${pkg}"
              if ! osc api -X POST "/source/${project}/${pkg}?cmd=runservice" >/dev/null; then
                echo "WARN: runservice failed for ${project}/${pkg}" >&2
                failed=$((failed + 1))
              fi
            done

            echo "project=${project} packages=${total} service_packages=${svc} runservice_failed=${failed}"
          }

          refresh_services_for_project "$OBS_BOOTSTRAP_PROJECT" "$OBS_BOOTSTRAP_REPO"

      - name: Rebuild bootstrap project first (glibc producer)
        env:
          OBS_BOOTSTRAP_PROJECT: ${{ secrets.OBS_BOOTSTRAP_PROJECT }}
          OBS_BOOTSTRAP_REPO: ${{ secrets.OBS_BOOTSTRAP_REPO }}
          OBS_ARCH: ${{ secrets.OBS_ARCH }}
        run: |
          set -euo pipefail

          retry_cmd() {
            local max_attempts="${RETRY_MAX_ATTEMPTS:-5}"
            local delay="${RETRY_INITIAL_DELAY:-3}"
            local attempt=1
            while true; do
              "$@" && return 0
              local rc=$?
              if [ "$attempt" -ge "$max_attempts" ]; then
                echo "ERROR: command failed after ${attempt} attempts (rc=${rc}): $*" >&2
                return "$rc"
              fi
              echo "WARN: command failed (rc=${rc}), retry ${attempt}/${max_attempts} in ${delay}s: $*" >&2
              sleep "$delay"
              attempt=$((attempt + 1))
              delay=$((delay * 2))
              if [ "$delay" -gt 30 ]; then
                delay=30
              fi
            done
          }

          : "${OBS_BOOTSTRAP_PROJECT:=home:neycrol:buildfactory-bootstrap}"
          : "${OBS_BOOTSTRAP_REPO:=bootstrap}"
          : "${OBS_ARCH:=x86_64}"
          retry_cmd osc rebuild --all --repo "$OBS_BOOTSTRAP_REPO" --arch "$OBS_ARCH" "$OBS_BOOTSTRAP_PROJECT"

      - name: Wait bootstrap glibc producer to finish
        env:
          OBS_BOOTSTRAP_PROJECT: ${{ secrets.OBS_BOOTSTRAP_PROJECT }}
          OBS_BOOTSTRAP_REPO: ${{ secrets.OBS_BOOTSTRAP_REPO }}
          OBS_ARCH: ${{ secrets.OBS_ARCH }}
        run: |
          set -euo pipefail

          retry_cmd() {
            local max_attempts="${RETRY_MAX_ATTEMPTS:-5}"
            local delay="${RETRY_INITIAL_DELAY:-3}"
            local attempt=1
            while true; do
              "$@" && return 0
              local rc=$?
              if [ "$attempt" -ge "$max_attempts" ]; then
                echo "ERROR: command failed after ${attempt} attempts (rc=${rc}): $*" >&2
                return "$rc"
              fi
              echo "WARN: command failed (rc=${rc}), retry ${attempt}/${max_attempts} in ${delay}s: $*" >&2
              sleep "$delay"
              attempt=$((attempt + 1))
              delay=$((delay * 2))
              if [ "$delay" -gt 30 ]; then
                delay=30
              fi
            done
          }

          : "${OBS_BOOTSTRAP_PROJECT:=home:neycrol:buildfactory-bootstrap}"
          : "${OBS_BOOTSTRAP_REPO:=bootstrap}"
          : "${OBS_ARCH:=x86_64}"

          timeout_sec=$((5 * 60 * 60))
          interval=30
          elapsed=0

          while true; do
            state="$(retry_cmd osc results "$OBS_BOOTSTRAP_PROJECT" -r "$OBS_BOOTSTRAP_REPO" -a "$OBS_ARCH" --csv \
              | awk -F';' '$1=="glibc-god"{print $2}')"

            echo "bootstrap glibc-god state=${state:-unknown} elapsed=${elapsed}s"
            case "$state" in
              succeeded|published|finished)
                break
                ;;
              failed|broken|unresolvable|excluded|disabled)
                echo "bootstrap glibc-god ended in non-success state: $state" >&2
                exit 1
                ;;
            esac

            if [ "$elapsed" -ge "$timeout_sec" ]; then
              echo "timeout waiting for bootstrap glibc-god to finish" >&2
              exit 1
            fi

            sleep "$interval"
            elapsed=$((elapsed + interval))
          done

      - name: Refresh source services (main only)
        env:
          OBS_MAIN_PROJECT: ${{ secrets.OBS_PROJECT }}
          OBS_MAIN_REPO: ${{ secrets.OBS_REPO }}
          OBS_ARCH: ${{ secrets.OBS_ARCH }}
        run: |
          set -euo pipefail

          : "${OBS_MAIN_PROJECT:=home:neycrol:buildfactory}"
          : "${OBS_MAIN_REPO:=buildfactory}"
          : "${OBS_ARCH:=x86_64}"

          retry_cmd() {
            local max_attempts="${RETRY_MAX_ATTEMPTS:-5}"
            local delay="${RETRY_INITIAL_DELAY:-3}"
            local attempt=1
            while true; do
              "$@" && return 0
              local rc=$?
              if [ "$attempt" -ge "$max_attempts" ]; then
                echo "ERROR: command failed after ${attempt} attempts (rc=${rc}): $*" >&2
                return "$rc"
              fi
              echo "WARN: command failed (rc=${rc}), retry ${attempt}/${max_attempts} in ${delay}s: $*" >&2
              sleep "$delay"
              attempt=$((attempt + 1))
              delay=$((delay * 2))
              if [ "$delay" -gt 30 ]; then
                delay=30
              fi
            done
          }

          failed=0
          total=0
          svc=0

          mapfile -t pkgs < <(retry_cmd osc ls "$OBS_MAIN_PROJECT")
          for pkg in "${pkgs[@]}"; do
            [ -n "$pkg" ] || continue
            total=$((total + 1))

            if ! osc cat "$OBS_MAIN_PROJECT" "$pkg" _service >/dev/null 2>&1; then
              continue
            fi
            svc=$((svc + 1))

            status_xml="$(osc api "/build/${OBS_MAIN_PROJECT}/${OBS_MAIN_REPO}/${OBS_ARCH}/${pkg}/_status" 2>/dev/null || true)"
            if echo "$status_xml" | grep -q 'code="building"'; then
              echo "skip runservice: ${OBS_MAIN_PROJECT}/${pkg} (currently building)"
              continue
            fi
            if echo "$status_xml" | grep -q 'service in progress'; then
              echo "skip runservice: ${OBS_MAIN_PROJECT}/${pkg} (service in progress)"
              continue
            fi

            echo "runservice: ${OBS_MAIN_PROJECT}/${pkg}"
            if ! osc api -X POST "/source/${OBS_MAIN_PROJECT}/${pkg}?cmd=runservice" >/dev/null; then
              echo "WARN: runservice failed for ${OBS_MAIN_PROJECT}/${pkg}" >&2
              failed=$((failed + 1))
            fi
          done

          echo "project=${OBS_MAIN_PROJECT} packages=${total} service_packages=${svc} runservice_failed=${failed}"

      - name: Trigger main project full rebuild on OBS
        env:
          OBS_MAIN_PROJECT: ${{ secrets.OBS_PROJECT }}
          OBS_MAIN_REPO: ${{ secrets.OBS_REPO }}
          OBS_ARCH: ${{ secrets.OBS_ARCH }}
        run: |
          set -euo pipefail

          retry_cmd() {
            local max_attempts="${RETRY_MAX_ATTEMPTS:-5}"
            local delay="${RETRY_INITIAL_DELAY:-3}"
            local attempt=1
            while true; do
              "$@" && return 0
              local rc=$?
              if [ "$attempt" -ge "$max_attempts" ]; then
                echo "ERROR: command failed after ${attempt} attempts (rc=${rc}): $*" >&2
                return "$rc"
              fi
              echo "WARN: command failed (rc=${rc}), retry ${attempt}/${max_attempts} in ${delay}s: $*" >&2
              sleep "$delay"
              attempt=$((attempt + 1))
              delay=$((delay * 2))
              if [ "$delay" -gt 30 ]; then
                delay=30
              fi
            done
          }

          : "${OBS_MAIN_PROJECT:=home:neycrol:buildfactory}"
          : "${OBS_MAIN_REPO:=buildfactory}"
          : "${OBS_ARCH:=x86_64}"
          # Main project holds the single consumer repo and includes glibc-god aggregate package.
          retry_cmd osc rebuild --all --repo "$OBS_MAIN_REPO" --arch "$OBS_ARCH" "$OBS_MAIN_PROJECT"
          # Ensure glibc aggregate is scheduled right after bootstrap producer completion.
          retry_cmd osc rebuildpac "$OBS_MAIN_PROJECT" glibc-god "$OBS_MAIN_REPO" "$OBS_ARCH" || true

      - name: Observe main project health window (do not block on signing tail)
        env:
          OBS_MAIN_PROJECT: ${{ secrets.OBS_PROJECT }}
          OBS_MAIN_REPO: ${{ secrets.OBS_REPO }}
          OBS_ARCH: ${{ secrets.OBS_ARCH }}
        run: |
          set -euo pipefail

          retry_cmd() {
            local max_attempts="${RETRY_MAX_ATTEMPTS:-5}"
            local delay="${RETRY_INITIAL_DELAY:-3}"
            local attempt=1
            while true; do
              "$@" && return 0
              local rc=$?
              if [ "$attempt" -ge "$max_attempts" ]; then
                echo "ERROR: command failed after ${attempt} attempts (rc=${rc}): $*" >&2
                return "$rc"
              fi
              echo "WARN: command failed (rc=${rc}), retry ${attempt}/${max_attempts} in ${delay}s: $*" >&2
              sleep "$delay"
              attempt=$((attempt + 1))
              delay=$((delay * 2))
              if [ "$delay" -gt 30 ]; then
                delay=30
              fi
            done
          }

          : "${OBS_MAIN_PROJECT:=home:neycrol:buildfactory}"
          : "${OBS_MAIN_REPO:=buildfactory}"
          : "${OBS_ARCH:=x86_64}"

          # We only need to verify that rebuild was accepted and no persistent
          # hard failure states remain. OBS signing/publishing tails can run for hours.
          monitor_sec=$((90 * 60))
          interval=60
          grace_sec=$((15 * 60))
          hard_fail_required=3
          hard_fail_confirmations=0
          elapsed=0

          while [ "$elapsed" -le "$monitor_sec" ]; do
            read -r succeeded blocked building scheduled dispatching signing finished failed broken unresolvable excluded disabled < <(
              retry_cmd osc results "$OBS_MAIN_PROJECT" -r "$OBS_MAIN_REPO" -a "$OBS_ARCH" --csv \
              | awk -F';' '
                  NF>=2 && $1!="_" { c[$2]++ }
                  END {
                    print c["succeeded"]+0, c["blocked"]+0, c["building"]+0,
                          c["scheduled"]+0, c["dispatching"]+0, c["signing"]+0,
                          c["finished"]+0, c["failed"]+0, c["broken"]+0,
                          c["unresolvable"]+0, c["excluded"]+0, c["disabled"]+0
                  }'
            )

            echo "main states: succeeded=${succeeded} blocked=${blocked} building=${building} scheduled=${scheduled} dispatching=${dispatching} signing=${signing} finished=${finished} failed=${failed} broken=${broken} unresolvable=${unresolvable} excluded=${excluded} disabled=${disabled} elapsed=${elapsed}s"

            hard_fail=$((failed + broken + unresolvable))
            core_active=$((building + scheduled + dispatching))

            if [ "$hard_fail" -gt 0 ]; then
              if [ "$elapsed" -lt "$grace_sec" ]; then
                echo "hard failure states observed in grace window (${elapsed}s < ${grace_sec}s); waiting for stabilization"
                hard_fail_confirmations=0
              elif [ "$core_active" -gt 0 ]; then
                hard_fail_confirmations=$((hard_fail_confirmations + 1))
                echo "hard failure states observed while queue active (confirmation ${hard_fail_confirmations}/${hard_fail_required})"
                if [ "$hard_fail_confirmations" -ge "$hard_fail_required" ]; then
                  echo "main project kept hard failure states during active queue; marking workflow failed" >&2
                  osc results "$OBS_MAIN_PROJECT" -r "$OBS_MAIN_REPO" -a "$OBS_ARCH" --csv \
                    | awk -F';' '$2=="failed" || $2=="broken" || $2=="unresolvable"{print}'
                  exit 1
                fi
              else
                echo "core queue drained but hard failure states remain; marking workflow failed" >&2
                osc results "$OBS_MAIN_PROJECT" -r "$OBS_MAIN_REPO" -a "$OBS_ARCH" --csv \
                  | awk -F';' '$2=="failed" || $2=="broken" || $2=="unresolvable"{print}'
                exit 1
              fi
            else
              hard_fail_confirmations=0
            fi

            if [ "$core_active" -eq 0 ]; then
              echo "core build queue is empty; leaving signing/blocked tail handling to OBS"
              exit 0
            fi

            sleep "$interval"
            elapsed=$((elapsed + interval))
          done

          echo "monitor window elapsed without hard failure states; workflow exits successfully while OBS continues long-tail signing/publishing"

      - name: Print current status summary
        env:
          OBS_BOOTSTRAP_PROJECT: ${{ secrets.OBS_BOOTSTRAP_PROJECT }}
          OBS_BOOTSTRAP_REPO: ${{ secrets.OBS_BOOTSTRAP_REPO }}
          OBS_MAIN_PROJECT: ${{ secrets.OBS_PROJECT }}
          OBS_MAIN_REPO: ${{ secrets.OBS_REPO }}
          OBS_ARCH: ${{ secrets.OBS_ARCH }}
        run: |
          : "${OBS_BOOTSTRAP_PROJECT:=home:neycrol:buildfactory-bootstrap}"
          : "${OBS_BOOTSTRAP_REPO:=bootstrap}"
          : "${OBS_MAIN_PROJECT:=home:neycrol:buildfactory}"
          : "${OBS_MAIN_REPO:=buildfactory}"
          : "${OBS_ARCH:=x86_64}"

          echo "=== bootstrap summary ==="
          osc results "$OBS_BOOTSTRAP_PROJECT" -r "$OBS_BOOTSTRAP_REPO" -a "$OBS_ARCH" || true
          echo "=== main summary ==="
          osc results "$OBS_MAIN_PROJECT" -r "$OBS_MAIN_REPO" -a "$OBS_ARCH" || true

          echo "=== single pacman repo (published path) ==="
          echo "https://downloadcontent.opensuse.org/repositories/home:/neycrol:/buildfactory/buildfactory/x86_64/"
          echo "db file: home_neycrol_buildfactory_buildfactory.db"
